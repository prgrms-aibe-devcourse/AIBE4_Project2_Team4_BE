<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{demo/demo-layout}">

<head>
  <title>ìƒë‹´ ì±„íŒ…ë°©</title>
  <style>
    /* ì±„íŒ…ë°© ì˜ì—­ ìŠ¤íƒ€ì¼ */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 75vh; /* ë†’ì´ ì•½ê°„ ì¦ê°€ */
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-md);
      background-color: var(--color-bg-surface);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .chat-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #fff;
    }

    .chat-messages {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
      background-color: var(--color-bg-page);
    }

    .message {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 0.95rem;
      line-height: 1.5;
      position: relative;
      word-break: break-word;
    }

    .message.received {
      align-self: flex-start;
      background-color: var(--color-bg-surface);
      border: 1px solid var(--color-border);
      border-top-left-radius: 2px;
    }

    .message.sent {
      align-self: flex-end;
      background-color: var(--color-brand-primary);
      color: var(--color-text-inverse);
      border-top-right-radius: 2px;
    }

    .message-time {
      font-size: 0.75rem;
      color: var(--color-text-secondary);
      margin-top: 4px;
      text-align: right;
    }

    .message.sent .message-time {
      color: rgba(255, 255, 255, 0.7);
    }

    .chat-input-area {
      padding: 16px 24px;
      border-top: 1px solid var(--color-border);
      background-color: var(--color-bg-surface);
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      padding: 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-sm);
      resize: none;
      height: 48px;
      min-height: 48px;
      max-height: 120px;
      font-family: inherit;
      line-height: 1.5;
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--color-brand-primary);
      box-shadow: 0 0 0 2px rgba(33, 37, 41, 0.1);
    }

    /* ì‚¬ì´ë“œ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
    .side-panel-card {
      background-color: var(--color-bg-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-md);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-sm);
    }

    .side-panel-title {
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .file-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-sm);
      margin-bottom: 8px;
      background-color: #fff;
      transition: background-color 0.2s;
    }

    .file-item:hover {
      background-color: var(--color-bg-neutral);
    }

    .file-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--color-bg-neutral);
      border-radius: 6px;
      margin-right: 12px;
      color: var(--color-text-secondary);
    }

    .file-info {
      flex: 1;
      min-width: 0;
    }

    .file-name {
      font-size: 0.9rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 2px;
    }

    .file-size {
      font-size: 0.75rem;
      color: var(--color-text-secondary);
    }

    .application-summary dt {
      font-size: 0.85rem;
      color: var(--color-text-secondary);
      margin-bottom: 4px;
    }

    .application-summary dd {
      font-size: 0.95rem;
      font-weight: 500;
      margin-bottom: 16px;
    }

    .application-summary dd:last-child {
      margin-bottom: 0;
    }
  </style>
</head>

<div layout:fragment="content">
  <div class="mb-4">
    <h2 class="fw-bold">ğŸ’¬ ìƒë‹´ ì±„íŒ…ë°©</h2>
    <p class="text-small">ë©˜í† ì™€ ììœ ë¡­ê²Œ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ì„¸ìš”.</p>
  </div>

  <div class="row g-4">
    <!-- ì™¼ìª½: ì±„íŒ…ë°© ì˜ì—­ -->
    <div class="col-lg-8">
      <div class="chat-container">
        <!-- ì±„íŒ…ë°© í—¤ë” -->
        <div class="chat-header">
          <div class="d-flex align-items-center">
            <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3"
                 style="width: 40px; height: 40px; border: 1px solid var(--color-border);">
              <img th:if="${consultationRoomDto.opponentMemberDto.profileUrl != null}"
                   th:src="${consultationRoomDto.opponentMemberDto.profileUrl}" alt="Profile" class="rounded-circle"
                   style="width: 100%; height: 100%; object-fit: cover;">
              <i th:unless="${consultationRoomDto.opponentMemberDto.profileUrl != null}"
                 class="bi bi-person-fill text-secondary fs-5"></i>
            </div>
            <div>
              <div class="fw-bold" th:text="${consultationRoomDto.opponentMemberDto.nickname}">ìƒëŒ€ë°©</div>
              <div class="text-small" style="font-size: 0.8rem;"
                   th:text="${consultationRoomDto.myRole == 'MENTOR' ? 'ë©˜í‹°' : 'ë©˜í† '}">ìƒëŒ€ë°© ì—­í• 
              </div>
            </div>
          </div>
          <div>
            <button class="btn btn-sm btn-outline-custom">
              <i class="bi bi-box-arrow-right me-1"></i>ë‚˜ê°€ê¸°
            </button>
          </div>
        </div>

        <!-- ë©”ì‹œì§€ ëª©ë¡ -->
        <div class="chat-messages" id="chatMessages">
          <!-- ë©”ì‹œì§€ ë°˜ë³µ ì¶œë ¥ -->
          <th:block th:each="message : ${consultationRoomDto.messageDtoList}">

            <!-- ì‹œìŠ¤í…œ ë©”ì‹œì§€ì¸ ê²½ìš° -->
            <div th:if="${message.type == 'SYSTEM'}" class="text-center my-3">
                             <span class="badge bg-light text-secondary fw-normal border px-3 py-2 rounded-pill"
                                   style="font-size: 0.85rem; white-space: normal;"
                                   th:text="${message.content}">
                                 ì‹œìŠ¤í…œ ë©”ì‹œì§€ì…ë‹ˆë‹¤.
                             </span>
            </div>

            <!-- ì¼ë°˜ ë©”ì‹œì§€ (TEXT, IMAGE ë“±) -->
            <div th:unless="${message.type == 'SYSTEM'}"
                 class="message"
                 th:classappend="${message.isMine} ? 'sent' : 'received'">

              <!-- ì´ë¯¸ì§€ ë©”ì‹œì§€ì¸ ê²½ìš° -->
              <div th:if="${message.type == 'IMAGE'}">
                <img th:src="${message.content}" alt="ì´ë¯¸ì§€" style="max-width: 100%; border-radius: 8px; cursor: pointer;"
                     onclick="window.open(this.src)">
              </div>

              <!-- í…ìŠ¤íŠ¸ ë©”ì‹œì§€ì¸ ê²½ìš° -->
              <span th:unless="${message.type == 'IMAGE'}" th:text="${message.content}">ë©”ì‹œì§€ ë‚´ìš©</span>

              <!-- ì‹œê°„ ì •ë³´ëŠ” MessageDtoì— ì—†ì–´ì„œ ì„ì‹œë¡œ ì œì™¸í•˜ê±°ë‚˜ ì¶”ê°€ í•„ìš” -->
              <!-- <div class="message-time">ì˜¤ì „ 10:00</div> -->
            </div>
          </th:block>

          <!-- ë©”ì‹œì§€ê°€ ì—†ì„ ê²½ìš° ì•ˆë‚´ ë¬¸êµ¬ (ì„ íƒ ì‚¬í•­) -->
          <div th:if="${#lists.isEmpty(consultationRoomDto.messageDtoList)}" class="text-center text-secondary my-5">
            <p>ëŒ€í™” ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”!</p>
          </div>
        </div>

        <!-- ì…ë ¥ ì˜ì—­ -->
        <div class="chat-input-area">
          <button class="btn btn-outline-custom px-2" title="íŒŒì¼ ì²¨ë¶€">
            <i class="bi bi-paperclip fs-5"></i>
          </button>
          <textarea class="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="1"></textarea>
          <button class="btn btn-primary-custom" style="height: 48px; padding-left: 1.5rem; padding-right: 1.5rem;">ì „ì†¡
          </button>
        </div>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ì‚¬ì´ë“œ íŒ¨ë„ -->
    <div class="col-lg-4">
      <!-- 1. ìƒë‹´ ì‹ ì²­ì„œ ìš”ì•½ -->
      <div class="side-panel-card">
        <div class="side-panel-title">
          <span>ğŸ“„ ìƒë‹´ ì‹ ì²­ì„œ</span>
          <!-- <a href="#" class="text-small text-decoration-underline">ì „ì²´ë³´ê¸°</a> -->
        </div>
        <dl class="application-summary mb-0">
          <dt>ì‹ ì²­ ì œëª©</dt>
          <dd th:text="${consultationRoomDto.consultingApplicationDto.title}">ìŠ¤í”„ë§ ë¶€íŠ¸ ì•„í‚¤í…ì²˜ ì„¤ê³„ ì¡°ì–¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤.</dd>

          <dt>í¬ë§ ì§ë¬´</dt>
          <dd><span class="tag tag--read-only mb-0 py-1 px-2" style="font-size: 0.8rem;"
                    th:text="${consultationRoomDto.consultingApplicationDto.consultingTag}">ë°±ì—”ë“œ/ì„œë²„</span></dd>

          <dt>ìƒë‹´ ë‚´ìš© ìš”ì•½</dt>
          <dd class="text-secondary" style="font-size: 0.9rem; line-height: 1.4;"
              th:text="${consultationRoomDto.consultingApplicationDto.content}">
            í˜„ì¬ ì¡¸ì—… í”„ë¡œì íŠ¸ë¡œ ì‡¼í•‘ëª°ì„ ë§Œë“¤ê³  ìˆëŠ”ë°, íŒ¨í‚¤ì§€ êµ¬ì¡°ë¥¼ ì–´ë–»ê²Œ ì¡ì•„ì•¼ ìœ ì§€ë³´ìˆ˜ì— ì¢‹ì„ì§€ ê³ ë¯¼ì…ë‹ˆë‹¤...
          </dd>

          <!-- ì‹ ì²­ ì¼ì‹œëŠ” DTOì— ì—†ì–´ì„œ ì œì™¸í•˜ê±°ë‚˜ ì¶”ê°€ í•„ìš” -->
          <!-- <dt>ì‹ ì²­ ì¼ì‹œ</dt>
          <dd class="mb-0">2024.02.13 14:30</dd> -->
        </dl>
      </div>

      <!-- 2. ì£¼ê³ ë°›ì€ íŒŒì¼ -->
      <div class="side-panel-card">
        <div class="side-panel-title">
          <span>ğŸ—‚ ì£¼ê³ ë°›ì€ íŒŒì¼</span>
          <!-- <span class="badge bg-secondary rounded-pill">1</span> -->
        </div>

        <div class="file-list">
          <!-- ì‹ ì²­ì„œ ì²¨ë¶€ íŒŒì¼ì´ ìˆëŠ” ê²½ìš° í‘œì‹œ -->
          <a th:if="${consultationRoomDto.consultingApplicationDto.fileUrl != null}"
             th:href="${consultationRoomDto.consultingApplicationDto.fileUrl}"
             class="file-item text-decoration-none" target="_blank">
            <div class="file-icon">
              <i class="bi bi-file-earmark-text"></i>
            </div>
            <div class="file-info">
              <div class="file-name text-dark">ì‹ ì²­ì„œ ì²¨ë¶€íŒŒì¼</div>
              <div class="file-size">ë‹¤ìš´ë¡œë“œ</div>
            </div>
            <div class="ms-2 text-secondary">
              <i class="bi bi-download"></i>
            </div>
          </a>

          <div th:unless="${consultationRoomDto.consultingApplicationDto.fileUrl != null}"
               class="text-center text-secondary py-3">
            <small>ì£¼ê³ ë°›ì€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</small>
          </div>
        </div>

        <!-- <div class="text-center mt-3">
            <button class="btn btn-sm btn-outline-custom w-100">íŒŒì¼ ë”ë³´ê¸°</button>
        </div> -->
      </div>
    </div>
  </div>
</div>

<th:block layout:fragment="script">
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.scrollTop = chatMessages.scrollHeight;

      // í…ìŠ¤íŠ¸ ì˜ì—­ ìë™ ë†’ì´ ì¡°ì ˆ
      const textarea = document.querySelector('.chat-input');
      textarea.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        if (this.value === '') {
          this.style.height = '48px';
        }
      });
    });
  </script>
</th:block>

</html>
