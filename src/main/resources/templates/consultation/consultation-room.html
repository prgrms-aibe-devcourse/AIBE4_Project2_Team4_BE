<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/base}">

<head>
  <title>ìƒë‹´ ì±„íŒ…ë°©</title>
  <link rel="stylesheet" th:href="@{/css/consultation/consultation-room.css}">
</head>

<div layout:fragment="content">
  <div class="mb-4">
    <h2 class="fw-bold">ğŸ’¬ ìƒë‹´ ì±„íŒ…ë°©</h2>
    <p class="text-small">ìƒëŒ€ë°©ê³¼ ììœ ë¡­ê²Œ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ì„¸ìš”.</p>
  </div>

  <div class="row g-4">
    <div class="col-lg-8">
      <div class="chat-container">
        <div class="chat-header">
          <div class="d-flex align-items-center">
            <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3"
                 style="width: 40px; height: 40px; border: 1px solid var(--color-border);">
              <!--/*@thymesVar id="profileUrl" type=""*/-->
              <img th:if="${consultationRoomDto.memberDto.profileUrl != null}"
                   th:src="${consultationRoomDto.memberDto.profileUrl}" alt="Profile" class="rounded-circle"
                   style="width: 100%; height: 100%; object-fit: cover;">
              <i th:unless="${consultationRoomDto.memberDto.profileUrl != null}"
                 class="bi bi-person-fill text-secondary fs-5"></i>
            </div>
            <div>
              <div class="fw-bold" th:text="${consultationRoomDto.memberDto.nickname}">ìƒëŒ€ë°©</div>
              <div class="text-small" style="font-size: 0.8rem;"
                   th:text="${consultationRoomDto.myRole == 'MENTOR' ? 'ë©˜í‹°' : 'ë©˜í† '}">ìƒëŒ€ë°© ì—­í• 
              </div>
            </div>
          </div>
          <div>
            <button class="btn btn-sm btn-outline-custom">
              <i class="bi bi-box-arrow-right me-1"></i>ë‚˜ê°€ê¸°
            </button>
          </div>
        </div>

        <div class="chat-messages" id="chatMessages">
          <th:block th:each="message : ${consultationRoomDto.messageDtoList}">

            <div th:if="${message.type == 'SYSTEM'}" class="text-center my-3">
      <span class="badge bg-light text-secondary fw-normal border px-3 py-2 rounded-pill"
            th:text="${message.content}">ì‹œìŠ¤í…œ ë©”ì‹œì§€</span>
            </div>

            <div th:unless="${message.type == 'SYSTEM'}"
                 class="d-flex flex-column mb-2"
                 th:classappend="${message.senderId == currentMemberId} ? 'align-items-end' : 'align-items-start'">

      <span th:if="${message.senderId != currentMemberId}"
            th:text="${message.senderNickname}"
            class="fw-bold text-secondary mb-1 ms-1"
            style="font-size: 0.8rem;">ë‹‰ë„¤ì„</span>

              <div class="message"
                   th:classappend="${message.senderId == currentMemberId} ? 'sent' : 'received'">
                <div th:if="${message.type == 'IMAGE'}">
                  <img th:src="${message.content}" alt="ì´ë¯¸ì§€" style="max-width: 100%; border-radius: 8px; cursor: pointer;"
                       onclick="window.open(this.src)">
                </div>
                <span th:unless="${message.type == 'IMAGE'}" th:text="${message.content}">ë‚´ìš©</span>
              </div>
            </div>

          </th:block>
        </div>

        <div class="chat-input-area">
          <button class="btn btn-outline-custom px-2" title="íŒŒì¼ ì²¨ë¶€">
            <i class="bi bi-paperclip fs-5"></i>
          </button>
          <textarea class="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="1"></textarea>
          <button id="send-btn" class="btn btn-primary-custom" style="height: 48px; padding-left: 1.5rem; padding-right: 1.5rem;">ì „ì†¡
          </button>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="side-panel-card">
        <div class="side-panel-title">
          <span>ğŸ“„ ìƒë‹´ ì‹ ì²­ì„œ</span>
        </div>
        <dl class="application-summary mb-0">
          <dt>ì‹ ì²­ ì œëª©</dt>
          <dd th:text="${consultationRoomDto.consultingApplicationDto.title}">ì œëª©</dd>

          <dt>í¬ë§ ì§ë¬´</dt>
          <dd><span class="tag tag--read-only mb-0 py-1 px-2" style="font-size: 0.8rem;"
                    th:text="${consultationRoomDto.consultingApplicationDto.consultingTag}">íƒœê·¸</span></dd>

          <dt>ìƒë‹´ ë‚´ìš© ìš”ì•½</dt>
          <dd class="text-secondary" style="font-size: 0.9rem; line-height: 1.4;"
              th:text="${consultationRoomDto.consultingApplicationDto.content}">
            ë‚´ìš©
          </dd>
        </dl>
      </div>

      <div class="side-panel-card">
        <div class="side-panel-title">
          <span>ğŸ—‚ ì£¼ê³ ë°›ì€ íŒŒì¼</span>
        </div>
        <div class="file-list">
          <a th:if="${consultationRoomDto.consultingApplicationDto.fileUrl != null}"
             th:href="${consultationRoomDto.consultingApplicationDto.fileUrl}"
             class="file-item text-decoration-none" target="_blank">
            <div class="file-icon"><i class="bi bi-file-earmark-text"></i></div>
            <div class="file-info">
              <div class="file-name text-dark">ì‹ ì²­ì„œ ì²¨ë¶€íŒŒì¼</div>
              <div class="file-size">ë‹¤ìš´ë¡œë“œ</div>
            </div>
            <div class="ms-2 text-secondary">
              <i class="bi bi-download"></i>
            </div>
          </a>
          <div th:unless="${consultationRoomDto.consultingApplicationDto.fileUrl != null}"
               class="text-center text-secondary py-3">
            <small>ì£¼ê³ ë°›ì€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<th:block layout:fragment="script">
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
      // 1. ì´ˆê¸°í™” ë° ìŠ¤í¬ë¡¤ ì„¤ì •
      const chatMessages = document.getElementById('chatMessages');
      const textarea = document.querySelector('.chat-input');
      const sendBtn = document.getElementById('send-btn');

      const roomId = [[${consultationRoomDto.consultationRoomId}]];
      const currentMemberId = [[${consultationRoomDto.memberDto.memberId}]]; // ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì „ë‹¬ í•„ìš”

      if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;

      // 2. ì›¹ì†Œì¼“ ì—°ê²° ì„¤ì •
      // WebSocketConfigurationì— ì„¤ì •ëœ ì—”ë“œí¬ì¸íŠ¸ì™€ ì¼ì¹˜í•´ì•¼ í•¨ (/ws)
      const socket = new SockJS('/ws');
      const stompClient = Stomp.over(socket);

      stompClient.connect({}, function (frame) {
        console.log('Connected: ' + frame);

        // íŠ¹ì • ìƒë‹´ë°© ì±„ë„ êµ¬ë…
        stompClient.subscribe('/topic/room/' + roomId, function (response) {
          const message = JSON.parse(response.body);
          appendMessage(message);
        });
      }, function(error) {
        console.error('ì›¹ì†Œì¼“ ì—°ê²° ì‹¤íŒ¨: ' + error);
      });

      // 3. ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
      function sendMessage() {
        const content = textarea.value.trim();
        if (content && stompClient.connected) {
          stompClient.send("/app/chat/send", {}, JSON.stringify({
            'roomId': roomId,
            'senderId': currentMemberId,
            'content': content
          }));
          textarea.value = '';
          textarea.style.height = '48px';
        } else {
            console.warn("ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‚´ìš©ì´ ë¹„ì—ˆê±°ë‚˜ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        }
      }

      // 4. ë©”ì‹œì§€ í™”ë©´ ì¶”ê°€ í•¨ìˆ˜
      function appendMessage(message) {
        // 1. ì „ì²´ë¥¼ ê°ì‹¸ëŠ” Wrapper ìƒì„± (ì •ë ¬ ë‹´ë‹¹)
        const wrapperDiv = document.createElement('div');
        wrapperDiv.className = 'd-flex flex-column mb-2'; // ë¶€íŠ¸ìŠ¤íŠ¸ë© í´ë˜ìŠ¤ í™œìš©

        // íƒ€ì… ë¹„êµ (== ì‚¬ìš©)
        const isMine = message.senderId == currentMemberId;

        if (message.type === 'SYSTEM') {
          wrapperDiv.className = 'text-center my-3';
          wrapperDiv.innerHTML = `<span class="badge bg-light text-secondary fw-normal border px-3 py-2 rounded-pill">${message.content}</span>`;
        } else {
          // 2. ì •ë ¬ í´ë˜ìŠ¤ ì¶”ê°€ (ë‚´ ê±°ë©´ ì˜¤ë¥¸ìª½, ë‚¨ì˜ ê±°ë©´ ì™¼ìª½)
          wrapperDiv.classList.add(isMine ? 'align-items-end' : 'align-items-start');

          // 3. ìƒëŒ€ë°© ë©”ì‹œì§€ì¼ ê²½ìš° ë‹‰ë„¤ì„ ì¶”ê°€
          if (!isMine) {
            const nicknameSpan = document.createElement('span');
            nicknameSpan.className = 'fw-bold text-secondary mb-1 ms-1';
            nicknameSpan.style.fontSize = '0.8rem';
            nicknameSpan.textContent = message.senderNickname; // DTOì— ìˆëŠ” ë‹‰ë„¤ì„ ì‚¬ìš©
            wrapperDiv.appendChild(nicknameSpan);
          }

          // 4. ë§í’ì„ (Bubble) ìƒì„±
          const messageDiv = document.createElement('div');
          messageDiv.className = `message ${isMine ? 'sent' : 'received'}`;

          let contentHtml = '';
          if (message.type === 'IMAGE') {
            contentHtml = `<img src="${message.content}" style="max-width: 100%; border-radius: 8px; cursor: pointer;" onclick="window.open(this.src)">`;
          } else {
            contentHtml = `<span>${message.content}</span>`;
          }
          messageDiv.innerHTML = contentHtml;

          // Wrapperì— ë§í’ì„  ë„£ê¸°
          wrapperDiv.appendChild(messageDiv);
        }

        // ìµœì¢…ì ìœ¼ë¡œ ì±„íŒ…ì°½ì— Wrapper ì¶”ê°€
        chatMessages.appendChild(wrapperDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // 5. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (í´ë¦­ ë° ì—”í„°í‚¤)
      if (sendBtn) {
          sendBtn.addEventListener('click', sendMessage);
      }

      if (textarea) {
          textarea.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              sendMessage();
            }
          });

          // ì…ë ¥ì°½ ìë™ ë†’ì´ ì¡°ì ˆ
          textarea.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if (this.value === '') this.style.height = '48px';
          });
      }
    });
  </script>
</th:block>

</html>
